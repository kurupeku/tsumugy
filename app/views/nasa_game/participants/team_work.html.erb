<% content_for(:title) { t(".page_title") } %>

<div class="min-h-screen flex flex-col pb-4"
     data-controller="nasa-game--session-subscription nasa-game--group-subscription"
     data-nasa-game--session-subscription-session-id-value="<%= @session.id %>"
     data-nasa-game--session-subscription-current-phase-value="<%= @session.phase %>"
     data-nasa-game--session-subscription-terminated-title-value="<%= t('nasa_game.session_terminated.title') %>"
     data-nasa-game--session-subscription-terminated-message-value="<%= t('nasa_game.session_terminated.message') %>"
     data-nasa-game--session-subscription-terminated-confirm-value="<%= t('nasa_game.session_terminated.confirm') %>"
     data-nasa-game--group-subscription-group-id-value="<%= @group.id %>"
     data-nasa-game--group-subscription-participant-id-value="<%= @participant.id %>">
  <%# Header %>
  <div class="navbar bg-base-100 shadow-lg sticky top-0 z-20">
    <div class="flex-1">
      <span class="text-xl">ðŸš€</span>
      <span class="font-bold ml-2"><%= @group.name %></span>
    </div>
    <div class="flex-none gap-2">
      <button class="btn btn-ghost btn-circle btn-sm" onclick="document.getElementById('mission-overview-modal').showModal()" title="<%= t('nasa_game.participants.mission_modal.button_title') %>">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" />
        </svg>
      </button>
      <% if @group.completed? %>
        <div class="badge badge-success"><%= t(".completed") %></div>
      <% else %>
        <div class="badge badge-secondary gap-1">
          <span class="w-2 h-2 bg-secondary-content rounded-full animate-pulse"></span>
          <%= t(".participants_count", count: @group.participants.count) %>
        </div>
      <% end %>
    </div>
  </div>

  <%= render "nasa_game/participants/mission_overview_modal" %>

  <%# Instructions %>
  <div class="bg-warning/10 border-b border-warning/30 p-3 text-center">
    <p class="text-sm text-warning">
      <%= t(".instruction_html") %>
    </p>
  </div>

  <%# Team Ranking List %>
  <div class="flex-1 p-4 max-w-lg mx-auto w-full">
    <% if @group.completed? %>
      <%# Read-only view after completion %>
      <div class="alert alert-success mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        <span><%= t(".completed_message") %></span>
      </div>
    <% end %>

    <%= render "nasa_game/participants/team_ranking_list", group: @group, group_rankings: @group_rankings %>
  </div>

  <%# Participant Individual Rankings (Collapsible) %>
  <div class="px-4 pb-4 max-w-lg mx-auto w-full <%= @group.completed? ? '' : 'pb-24' %>">
    <div class="collapse collapse-arrow bg-base-100 shadow">
      <input type="checkbox" />
      <div class="collapse-title font-medium text-sm">
        <%= t(".reference_title") %>
      </div>
      <div class="collapse-content">
        <div class="overflow-x-auto">
          <table class="table table-xs">
            <thead>
              <tr>
                <th class="w-8"><%= t(".item_header") %></th>
                <% @group.participants.each do |p| %>
                  <th class="text-center min-w-12">
                    <span class="badge badge-ghost badge-sm <%= p == @participant ? 'badge-primary' : '' %>">
                      <%= p.display_name.truncate(4) %>
                    </span>
                  </th>
                <% end %>
              </tr>
            </thead>
            <tbody>
              <% NasaGame::Item.all.each do |item| %>
                <tr>
                  <td class="text-xs text-base-content/60 max-w-24 truncate" title="<%= item.name %>">
                    <%= item.name.truncate(10) %>
                  </td>
                  <% @group.participants.each do |p| %>
                    <% rank = p.individual_rankings.find { |r| r.item_id == item.id }&.rank %>
                    <td class="text-center">
                      <span class="font-bold text-sm"><%= rank || "-" %></span>
                    </td>
                  <% end %>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <%# Fixed Bottom Action %>
  <% unless @group.completed? %>
    <div class="fixed bottom-0 left-0 right-0 bg-base-100 border-t border-base-300 p-4 z-10"
         data-controller="confirm-dialog"
         data-confirm-dialog-form-id-value="submit-team-form">
      <div class="max-w-lg mx-auto">
        <%= form_with url: nasa_game_group_path(@group),
            method: :patch,
            id: "submit-team-form",
            class: "hidden" do %>
        <% end %>
        <button type="button"
                class="btn btn-primary btn-lg w-full"
                data-action="confirm-dialog#open">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <%= t(".submit") %>
        </button>
        <%= render "shared/confirm_dialog",
                   id: "submit-team-modal",
                   title: t(".submit"),
                   message: t(".submit_confirm"),
                   confirm_label: t(".submit") %>
      </div>
    </div>
  <% end %>
</div>
