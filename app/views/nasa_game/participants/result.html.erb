<% content_for(:title) { "結果発表 | NASAゲーム" } %>

<%
  def score_evaluation(score)
    case score
    when 0..25 then "優秀"
    when 26..32 then "良好"
    when 33..45 then "平均的"
    when 46..55 then "まあまあ"
    when 56..70 then "要改善"
    else "もっと頑張ろう"
    end
  end
%>

<div class="min-h-screen pb-8">
  <%# Header %>
  <div class="navbar bg-base-100 shadow-lg sticky top-0 z-20">
    <div class="flex-1">
      <span class="text-xl">🏆</span>
      <span class="font-bold ml-2">結果発表</span>
    </div>
    <div class="flex-none">
      <span class="badge badge-primary"><%= @group.name %></span>
    </div>
  </div>

  <div class="p-4 max-w-2xl mx-auto space-y-6">
    <%# Score Summary %>
    <div class="stats stats-vertical sm:stats-horizontal shadow w-full bg-base-100">
      <div class="stat">
        <div class="stat-figure text-primary">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
        </div>
        <div class="stat-title">あなたの個人スコア</div>
        <div class="stat-value text-primary"><%= @individual_score %></div>
        <div class="stat-desc"><%= score_evaluation(@individual_score) %></div>
      </div>

      <div class="stat">
        <div class="stat-figure text-secondary">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
        </div>
        <div class="stat-title">チームスコア</div>
        <div class="stat-value text-secondary"><%= @team_score %></div>
        <div class="stat-desc"><%= score_evaluation(@team_score) %></div>
      </div>

      <div class="stat">
        <div class="stat-figure <%= @synergy_effect >= 0 ? 'text-success' : 'text-error' %>">
          <% if @synergy_effect >= 0 %>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
          <% else %>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path></svg>
          <% end %>
        </div>
        <div class="stat-title">シナジー効果</div>
        <div class="stat-value <%= @synergy_effect >= 0 ? 'text-success' : 'text-error' %>">
          <%= @synergy_effect >= 0 ? "+" : "" %><%= @synergy_effect %>
        </div>
        <div class="stat-desc">
          <%= @synergy_effect >= 0 ? "チームワークが効果的でした" : "改善の余地があります" %>
        </div>
      </div>
    </div>

    <%# Score Guide %>
    <div class="alert">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-info shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
      <div class="text-sm">
        <strong>スコアの見方:</strong> 誤差の合計値です。<strong>数値が小さいほど優秀</strong>です。
        0-25点で優秀、26-32点で良好、33-45点で平均的、46点以上で要改善です。
      </div>
    </div>

    <%# Detailed Comparison Table %>
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body p-0">
        <div class="overflow-x-auto">
          <table class="table table-sm">
            <thead>
              <tr class="bg-base-200">
                <th class="text-center w-12">正解</th>
                <th>アイテム</th>
                <th class="text-center w-16">個人</th>
                <th class="text-center w-16">チーム</th>
                <th class="text-center w-12">誤差</th>
              </tr>
            </thead>
            <tbody>
              <% NasaGame::Item.all.sort_by(&:correct_rank).each do |item| %>
                <% individual_rank = @individual_rankings.find { |r| r.item_id == item.id }&.rank %>
                <% team_rank = @group_rankings.find { |r| r.item_id == item.id }&.rank %>
                <% individual_error = individual_rank ? (individual_rank - item.correct_rank).abs : 0 %>
                <% team_error = team_rank ? (team_rank - item.correct_rank).abs : 0 %>
                <tr class="hover">
                  <td class="text-center">
                    <span class="badge badge-success badge-sm font-bold">
                      <%= item.correct_rank %>
                    </span>
                  </td>
                  <td>
                    <div class="font-medium text-sm"><%= item.name_ja %></div>
                  </td>
                  <td class="text-center">
                    <span class="<%= individual_error == 0 ? 'text-success font-bold' : '' %>">
                      <%= individual_rank %>
                    </span>
                  </td>
                  <td class="text-center">
                    <span class="<%= team_error == 0 ? 'text-success font-bold' : '' %>">
                      <%= team_rank %>
                    </span>
                  </td>
                  <td class="text-center">
                    <span class="badge badge-sm <%= team_error == 0 ? 'badge-success' : team_error <= 2 ? 'badge-warning' : 'badge-error' %>">
                      <%= team_error %>
                    </span>
                  </td>
                </tr>
              <% end %>
            </tbody>
            <tfoot>
              <tr class="bg-base-200 font-bold">
                <td colspan="2" class="text-right">合計誤差:</td>
                <td class="text-center text-primary"><%= @individual_score %></td>
                <td class="text-center text-secondary"><%= @team_score %></td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <%# NASA Reasoning (Expandable) %>
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title text-lg mb-4">
          NASAの解説
          <div class="badge badge-info badge-sm">公式回答</div>
        </h2>

        <div class="space-y-2">
          <% NasaGame::Item.all.sort_by(&:correct_rank).each do |item| %>
            <div class="collapse collapse-arrow bg-base-200">
              <input type="checkbox" />
              <div class="collapse-title text-sm font-medium flex items-center gap-2">
                <span class="badge badge-success badge-sm"><%= item.correct_rank %></span>
                <%= item.name_ja %>
              </div>
              <div class="collapse-content">
                <p class="text-sm text-base-content/80"><%= item.reasoning_ja %></p>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <%# Group Members Result %>
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title text-lg mb-4">
          グループメンバーのスコア
        </h2>

        <div class="space-y-3">
          <%
            sorted_participants = @group.participants.sort_by do |p|
              p.individual_rankings.sum { |r| (r.rank - NasaGame::Item.find(r.item_id).correct_rank).abs }
            end
          %>
          <% sorted_participants.each_with_index do |p, index| %>
            <% score = p.individual_rankings.sum { |r| (r.rank - NasaGame::Item.find(r.item_id).correct_rank).abs } %>
            <div class="flex items-center gap-3">
              <div class="badge badge-lg <%= index == 0 ? 'badge-warning' : 'badge-ghost' %>">
                <%= index + 1 %>
              </div>
              <div class="flex-1">
                <div class="flex justify-between items-center mb-1">
                  <span class="font-medium <%= p == @participant ? 'text-primary' : '' %>">
                    <%= p.display_name %>
                    <%= "(あなた)" if p == @participant %>
                  </span>
                  <span class="font-bold"><%= score %>点</span>
                </div>
                <progress
                  class="progress <%= score <= 25 ? 'progress-success' : score <= 45 ? 'progress-warning' : 'progress-error' %> w-full h-2"
                  value="<%= [112 - score, 0].max %>"
                  max="112">
                </progress>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <%# Action Buttons %>
    <div class="flex gap-4 justify-center">
      <%= link_to root_path, class: "btn btn-outline" do %>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
        </svg>
        トップに戻る
      <% end %>
    </div>
  </div>
</div>
